{
  "Identifier": "CVE-2024-24752",
  "PackageSlug": "packagist/bref/bref",
  "Title": "Bref's Uploaded Files Not Deleted in Event-Driven Functions",
  "Description": "When Bref is used with the Event-Driven Function runtime and the handler is a `RequestHandlerInterface`, then the Lambda event is converted to a PSR7 object.\nDuring the conversion process, if the request is a MultiPart, each part is parsed and for each which contains a file, it is extracted and saved in `/tmp` with a random filename starting with `bref_upload_`.\n\nThe function implementing the logic follows:\n\n```php\nprivate static function parseBodyAndUploadedFiles(HttpRequestEvent $event): array\n{\n$bodyString = $event-\u003egetBody();\n$files = [];\n$parsedBody = null;\n$contentType = $event-\u003egetContentType();\nif ($contentType !== null \u0026\u0026 $event-\u003egetMethod() === 'POST') {\nif (str_starts_with($contentType, 'application/x-www-form-urlencoded')) {\nparse_str($bodyString, $parsedBody);\n} else {\n$document = new Part(\"Content-type: $contentType\\r\\n\\r\\n\" . $bodyString);\nif ($document-\u003eisMultiPart()) {\n$parsedBody = [];\nforeach ($document-\u003egetParts() as $part) {\nif ($part-\u003eisFile()) {\n$tmpPath = tempnam(sys_get_temp_dir(), 'bref_upload_');\nif ($tmpPath === false) {\nthrow new RuntimeException('Unable to create a temporary directory');\n}\nfile_put_contents($tmpPath, $part-\u003egetBody());\n$file = new UploadedFile($tmpPath, filesize($tmpPath), UPLOAD_ERR_OK, $part-\u003egetFileName(), $part-\u003egetMimeType());\n\nself::parseKeyAndInsertValueInArray($files, $part-\u003egetName(), $file);\n} else {\nself::parseKeyAndInsertValueInArray($parsedBody, $part-\u003egetName(), $part-\u003egetBody());\n}\n}\n}\n}\n}\nreturn [$files, $parsedBody];\n}\n```\n\nThe flow mimics what plain PHP does but it does not delete the temporary files when the request has been processed.",
  "Date": "2024-10-17",
  "Pubdate": "2024-02-01",
  "AffectedRange": "\u003c2.1.13",
  "FixedVersions": [
    "2.1.13"
  ],
  "AffectedVersions": "All versions before 2.1.13",
  "NotImpacted": "All versions starting from 2.1.13",
  "Solution": "Upgrade to version 2.1.13 or above.",
  "Urls": [
    "https://nvd.nist.gov/vuln/detail/CVE-2024-24752",
    "https://github.com/advisories/GHSA-x4hh-frx8-98r5",
    "https://github.com/brefphp/bref/security/advisories/GHSA-x4hh-frx8-98r5",
    "https://github.com/brefphp/bref/commit/350788de12880b6fd64c4c318ba995388bec840e",
    "https://github.com/brefphp/bref",
    "https://github.com/brefphp/bref/blob/2.1.12/src/Event/Http/Psr7Bridge.php#L94-L125"
  ],
  "CvssV2": "",
  "CvssV3": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
  "UUID": "bb6bb521-3ce2-47c3-837b-305a5b98bf37"
}